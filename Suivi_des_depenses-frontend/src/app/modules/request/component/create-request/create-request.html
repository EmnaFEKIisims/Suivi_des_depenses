<div class="container mt-4">
  <!-- Alerts Section -->
  <div class="alert-container">
    <div *ngIf="showSuccessAlert" class="alert alert-success alert-dismissible fade show custom-alert" role="alert">
      <div class="alert-content">
        <i class="bi bi-check-circle-fill alert-icon"></i>
        <div><strong>Success!</strong> {{ alertMessage || 'Request created successfully.' }}</div>
      </div>
      <button type="button" class="btn-close" (click)="showSuccessAlert = false"></button>
    </div>

    <div *ngIf="showErrorAlert" class="alert alert-danger alert-dismissible fade show custom-alert" role="alert">
      <div class="alert-content">
        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
        <div><strong>Error!</strong> {{ errorMessage || 'Failed to create request.' }}</div>
      </div>
      <button type="button" class="btn-close" (click)="showErrorAlert = false"></button>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="d-flex justify-content-between mb-4">
    <button class="btn btn-outline-secondary" (click)="navigateTo('/requests')">
      <i class="bi bi-arrow-left"></i> Back to Requests
    </button>
    <button class="btn btn-outline-primary" (click)="navigateTo('/home')">
      <i class="bi bi-house"></i> Home
    </button>
  </div>

  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">Create New Expense Request</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="requestForm" (ngSubmit)="onSubmit()">
        <div class="row g-3">
          <!-- Reference + Status -->
          <div class="col-md-6">
            <label class="form-label">Reference</label>
            <input class="form-control bg-light" formControlName="reference" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <!-- Status is fixed "SUBMITTED", readonly -->
            <input class="form-control bg-light" value="SUBMITTED" readonly />
          </div>

          <!-- Employee Lookup -->
          <div class="col-md-12">
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Employee CIN*</label>
                <div class="input-group">
                  <input class="form-control" 
                         [class.is-invalid]="!fullEmployee && employeeCIN && employeeCIN.trim() !== ''"
                         [(ngModel)]="employeeCIN" name="cin" [ngModelOptions]="{standalone: true}" />
                  <button type="button" class="btn btn-primary" (click)="fetchEmployee()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <div class="invalid-feedback" *ngIf="!fullEmployee && employeeCIN && employeeCIN.trim() !== ''">
                  Please fetch a valid employee
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input class="form-control bg-light" [value]="employeeFullName" readonly />
              </div>
            </div>
          </div>

          <!-- Project Lookup -->
          <div class="col-md-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Project Selection</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Method 1: By Reference -->
                  <div class="col-md-6">
                    <label class="form-label">Search by Reference</label>
                    <div class="input-group">
                      <input class="form-control" [(ngModel)]="projectReference" name="projectRef" [ngModelOptions]="{standalone: true}" />
                      <button type="button" class="btn btn-outline-primary" (click)="fetchProjectByReference()">
                        <i class="bi bi-search"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Combined Search and Select -->
                  <div class="col-md-6">
                    <label class="form-label">Search and Select Project*</label>
                    <ng-select
                      [items]="projects"
                      bindLabel="name"
                      bindValue="idProject"
                      [(ngModel)]="selectedProjectId"
                      [ngModelOptions]="{standalone: true}"
                      placeholder="Search or select project*"
                      [searchable]="true"
                      [clearable]="false"
                      [typeahead]="projectSearchTerm$"
                      [class.is-invalid]="!fullProject && (selectedProjectId || projectReference)"
                      (change)="selectProject($event)"
                      (search)="projectSearchTerm$.next($event.term)">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="!fullProject && (selectedProjectId || projectReference)">
                      Please fetch a valid project
                    </div>
                  </div>

                  <!-- Project Name Display -->
                  <div class="col-md-12 mt-3">
                    <label class="form-label">Selected Project</label>
                    <input class="form-control bg-light" 
                           [class.is-invalid]="!fullProject && (selectedProjectId || projectReference)"
                           [value]="projectName" readonly />
                    <div class="invalid-feedback" *ngIf="!fullProject && (selectedProjectId || projectReference)">
                      A valid project must be selected
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mission + Location -->
          <div class="col-md-6">
            <label class="form-label">Mission*</label>
            <input class="form-control" 
                   [class.is-invalid]="isFieldInvalid('mission')"
                   formControlName="mission" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('mission')">
              {{ getFieldError('mission') }}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Mission Location*</label>
            <input class="form-control" 
                   [class.is-invalid]="isFieldInvalid('missionLocation')"
                   formControlName="missionLocation" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('missionLocation')">
              {{ getFieldError('missionLocation') }}
            </div>
          </div>

          <!-- Start + Return Date -->
          <div class="col-md-6">
            <label class="form-label">Start Date*</label>
            <input type="date" class="form-control" 
                   [class.is-invalid]="isFieldInvalid('startDate')"
                   formControlName="startDate" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('startDate')">
              {{ getFieldError('startDate') }}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Return Date*</label>
            <input type="date" class="form-control" 
                   [class.is-invalid]="isFieldInvalid('returnDate')"
                   formControlName="returnDate" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('returnDate')">
              {{ getFieldError('returnDate') }}
            </div>
          </div>

          <!-- Reimbursement Method -->
          <div class="col-md-12">
            <label class="form-label">Reimbursement Method*</label>
            <div class="card" [class.border-danger]="isFieldInvalid('reimbursementMethod')">
              <div class="card-body p-3">
                <div class="d-flex gap-5">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" value="CASH_DESK" formControlName="reimbursementMethod" id="cash" />
                    <label class="form-check-label" for="cash">Cash</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" value="BANK_TRANSFER" formControlName="reimbursementMethod" id="bank" />
                    <label class="form-check-label" for="bank">Bank Transfer</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-danger small mt-1" *ngIf="isFieldInvalid('reimbursementMethod')">
              {{ getFieldError('reimbursementMethod') }}
            </div>
          </div>

          <!-- Request Details -->
          <div class="col-12 mt-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Expense Details</h5>
              <button type="button" class="btn btn-outline-primary rounded-circle p-0 btn-add" 
                      (click)="addDetail()" title="Add Detail"
                      style="width: 32px; height: 32px;">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>

            <div *ngFor="let detail of detailRows; let i = index; trackBy: trackByIndex" class="row g-2 align-items-end mb-3 detail-row">
              <div class="col-md-4">
                <input type="text" class="form-control" 
                       [class.is-invalid]="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'description')"
                       placeholder="Description*" 
                       [(ngModel)]="detail.description"
                       [ngModelOptions]="{standalone: true}" />
                <div class="invalid-feedback" *ngIf="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'description')">
                  Description is required
                </div>
              </div>
              <div class="col-md-2">
                <input type="number" class="form-control" 
                       [class.is-invalid]="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'amount')"
                       placeholder="Amount*" 
                       [(ngModel)]="detail.amount"
                       [ngModelOptions]="{standalone: true}"
                       (ngModelChange)="updateCurrencyTotals()" />
                <div class="invalid-feedback" *ngIf="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'amount')">
                  Amount must be greater than 0
                </div>
              </div>
              <div class="col-md-3">
                <ng-select
                  [items]="currencies"
                  bindLabel="description"
                  bindValue="code"
                  placeholder="Select currency*"
                  [(ngModel)]="detail.currency"
                  [ngModelOptions]="{standalone: true}"
                  [clearable]="false"
                  [searchable]="true"
                  [class.is-invalid]="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'currency')"
                  (ngModelChange)="onCurrencyChange(i, $event)">
                </ng-select>
                <div class="invalid-feedback" *ngIf="isAnyDetailFieldTouched(i) && isDetailFieldInvalid(i, 'currency')">
                  Currency is required
                </div>
              </div>
              <div class="col-md-2">
                <input class="form-control bg-light" placeholder="Code" [value]="detail.currency" readonly />
              </div>
              <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger" (click)="removeDetail(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Totals by Currency -->
          <div class="col-12 mt-3" *ngIf="usedCurrencies.length > 0">
            <div class="d-flex justify-content-center">
              <div class="total-amounts-container">
                <div class="total-header">
                  <i class="bi bi-calculator me-2"></i>
                  <span>Total Amounts</span>
                </div>
                <div class="currencies-display-inline">
                  <span class="total-text">
                    <span *ngFor="let currency of usedCurrencies; let i = index">
                      <span *ngIf="i === 0">Total </span>
                      <span class="currency-display">{{ currency }}: {{ totalAmounts[currency] || 0 | number:'1.2-2' }}</span>
                      <span *ngIf="i < usedCurrencies.length - 1"> , </span>
                    </span>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit / Cancel -->
          <div class="d-flex justify-content-end mt-4 gap-3">
            <button type="button" class="btn btn-outline-secondary px-4" (click)="navigateTo('/requests')">Cancel</button>
            <div class="d-flex flex-column align-items-end">
              <button type="submit" class="btn btn-primary px-4" [disabled]="requestForm.invalid || !hasValidDetails()">Create Request</button>
              <small *ngIf="!hasValidDetails() && detailRows.length > 0" class="text-danger mt-1">
                <i class="bi bi-exclamation-triangle"></i> At least one valid detail line is required
              </small>
              <small *ngIf="detailRows.length === 0" class="text-muted mt-1">
                <i class="bi bi-info-circle"></i> Add expense details to continue
              </small>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
